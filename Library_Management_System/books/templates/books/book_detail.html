{% extends "accounts/base.html" %}
{% block content %}
<article class="detail">
  <header>
    <h1>{{ book.title }}</h1>
    <p class="muted">by {{ book.author.name }}</p>
  </header>

  {% if book.cover %}<img src="{{ book.cover.url }}" class="detail-cover">{% endif %}

  <h3>About this book</h3>
  <p>{{ book.preview_text|linebreaks }}</p>

  <div class="actions">
    {% if user.is_authenticated %}
      {% if plan_type == "free" %}
        <p class="warn">You’re on Free. Preview only.</p>
        <a class="btn" href="{% url 'subscribe' %}">Upgrade to read full →</a>
      {% elif plan_type == "premium" %}
        <a class="btn" href="{% url 'read_book' book.pk %}">Read Full (counts toward 5/month)</a>
        <a class="btn-outline" href="{% url 'add_to_reading_list' book.pk %}">Save to Reading List</a>
      {% else %}
        <a class="btn" href="{% url 'read_book' book.pk %}">Read Full</a>
        {% if book.file %}
          <a class="btn-outline" href="{% url 'download_book' book.pk %}">Download</a>
        {% endif %}
        <a class="btn-outline" href="{% url 'add_to_reading_list' book.pk %}">Save to Reading List</a>
      {% endif %}
    {% else %}
      <a class="btn" href="{% url 'login' %}">Login to continue</a>
    {% endif %}
  </div>
  {% if user.is_authenticated %}
  <div class="card">
    <h4>Rate this book</h4>
    <form method="post">
      {% csrf_token %}
      <label>Rating (1-5)</label>
      <select name="rating">
        <option value="5">5 - Excellent</option>
        <option value="4">4 - Good</option>
        <option value="3">3 - Okay</option>
        <option value="2">2 - Poor</option>
        <option value="1">1 - Terrible</option>
      </select>
      <p><textarea name="comment" rows="3" placeholder="Leave a short comment (optional)"></textarea></p>
      <button class="btn" type="submit">Submit Review</button>
    </form>
  </div>
{% else %}
  <p><a href="{% url 'login' %}">Login to leave a review</a></p>
{% endif %}

<p>Average rating: {{ avg_rating|floatformat:1 }} / 5</p>

</article>
{% endblock %}
